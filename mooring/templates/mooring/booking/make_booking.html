{% extends 'mooring/base.html' %}
{% load static %}
{% load forms %}
{% block extra_css %}
    {{ block.super }}
    <style>
        #guest-dropdown{
            min-width:200px;
            padding: 5px;
        }
        #guest-dropdown li{
            padding: 5px;
        }
        .radio-title{
            font-weight: bold;
            font-size: 18px;

        }
        [v-cloak] {
            display: none;
        }
        .money_sign {
              position: absolute;
              margin-top: 5px;
              margin-left: -9px;
              font-weight: bold;
        }
    </style>
{% endblock %}

{% block content %}
<div id="addBooking">
{% if not booking %}
    <div class="container">
        <div class="row">
            <div class="col-lg-12"><div class="p-3 bg-light border rounded">
                <h3>Your session has expired, or you have not yet selected a mooring to book.</h3>
                <p>Please visit the <a href="{{EXPLORE_PARKS_SEARCH}}">map</a> to start a new mooring booking session.</p>
            </div></div>
        </div>
    </div>
{% else %}
    <form method="POST" name="addBookingForm" @submit.prevent="validate()" novalidate>
        <div class="container">
        <input id="booking_hash_id" name="booking_hash_id" type="hidden" value="{{ checkouthash }}" />
        {% csrf_token %}
        <div class="row">
            <div class="col-lg-12">
                <div class="p-3 bg-light border rounded">
                    <div class="row">
                        <div class="col-md-12">
                            <p v-cloak>
                            {% verbatim %}
                                <span class="text-danger">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-clock-fill me-1" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z"/></svg>
                                    Time Left to complete booking: <strong class="ms-1">{{ timeleft }}</strong>
                                </span>
                            {% endverbatim %}
                                <a class="btn btn-info" href="{% url 'public_abort_booking' %}?change=True">Change in-progress booking</a>
                                <a class="btn btn-warning" href="{% url 'public_abort_booking' %}">Cancel in-progress booking</a>
                                {% if booking.old_booking %}
                                     {% if payments_officer_group %}
                                     {% if occ == 'true' %}
                                         <a class="btn btn-danger" href="{% url 'public_make_booking' %}?occ=false">Remove override</a>
                                     {% else %}
                                         <a class="btn btn-danger" href="{% url 'public_make_booking' %}?occ=true">Override change fees</a>
                                     {% endif %}
                                     {% endif %}
                                {% endif %}
                            </p>
                            {% if show_errors %}
                            <div class="alert alert-danger">
                                <p>There were some problems with your submission:</p>
                                <ul>
                                {% for error in form.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                                {% for field in form %}{% for error in field.errors %}
                                    <li><b>{{ field.label }}:</b> {{ error }}</li>
                                {% endfor %}{% endfor %}
                                {% for error in vehicles.non_field_errors %}
                                    <li>{{ error }}</li>
                                {% endfor %}
                                {% for vehicle in vehicles %}{% for field, error in vehicle.errors.items %}
                                    <li><b>Vessel {{ forloop.counter }} ({{ field }}):</b> {{ error }}</li>
                                {% endfor %}{% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-12">
                            <div id='mooring_pricing_table'>
                                <div class="row pb-2 mb-2 border-bottom fw-bold text-muted">
                                    <div class="col-md-12 mb-2">
                                        <h3 class="text-primary">Mooring Fees</h3>
                                    </div>
                                    <div class="col-md-3">
                                        Mooring
                                    </div>
                                    <div class="col-md-1">
                                        Vessel
                                    </div>
                                    <div class="col-md-2">
                                        From
                                    </div>
                                    <div class="col-md-1">
                                    </div>
                                    <div class="col-md-2">
                                        To
                                    </div>
                                    <div class="col-md-1">
                                        Price
                                    </div>
                                    <div class="col-md-2 over_ride_price_mooring_header d-none">
                                        Price Override
                                    </div>
                                </div>

                                {% for bm in booking_mooring %}
                                <div class="row align-items-center py-2">
                                    <div class="col-md-3">
                                        {{ bm.campsite.mooringarea.name }} 
                                    </div>
                                    <div class="col-md-1">
                                        {% verbatim %}
                                            <small v-cloak>{{ rego.toUpperCase() }}</small>
                                        {% endverbatim %}
                                    </div>
                                    <div class="col-md-2">
                                        {{ bm.from_dt }} 
                                    </div>
                                    <div class="col-md-1 text-center text-muted">
                                        to
                                    </div>
                                    <div class="col-md-2">
                                        {{ bm.to_dt }}
                                    </div>
                                    <div class="col-md-1">
                                        ${{ bm.amount }}
                                    </div>
                                    <!-- Use Bootstrap's `input-group` for the price override field -->
                                    <div class="col-md-2 over_ride_price_mooring_body d-none">
                                        <div class="input-group input-group-sm">
                                            <span class="input-group-text">$</span>
                                            <input type='number' id='over_ride_mooring_price{{ bm.id }}' step='0.01' class='form-control' value='{{ bm.amount }}' @change="money_update($event)">
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>

                            <div id='admissions_pricing_table' v-if="payingAdmissions && linesAdmissions.length > 0" v-cloak>
                                <div class="row pb-2 mb-2 border-bottom fw-bold text-muted">
                                    <div class="col-md-12 mb-2">
                                        <h3 class="text-primary">Admission Fees</h3>
                                    </div>
                                    <div class="col-md-1">
                                        Adults
                                    </div>
                                    <div class="col-md-1">
                                        Children
                                    </div>
                                    <div class="col-md-1">
                                        Infants
                                    </div>
                                    <div class="col-md-1">
                                        &nbsp;
                                    </div>
                                    <div class="col-md-2">
                                        From
                                    </div>
                                    <div class="col-md-1">
                                    </div>
                                    <div class="col-md-2">
                                        To
                                    </div>
                                    <div class="col-md-1">
                                        Price
                                    </div>
                                    <div class="col-md-2 over_ride_price_mooring_header d-none">
                                        Price Override
                                    </div>
                                </div>
                                {% verbatim %}
                                <div class="row align-items-center py-2" v-for="line in linesAdmissions" :key="line.rowid" v-cloak>
                                    <div class="col-md-1">
                                        {{ numAdults }}
                                    </div>
                                    <div class="col-md-1">
                                        {{ numChildren }}
                                    </div>
                                    <div class="col-md-1">
                                        {{ numInfants }}
                                    </div>
                                    <div class="col-md-1">
                                    </div>
                                    <div class="col-md-2">
                                        {{ line.from }}
                                    </div>
                                    <div class="col-md-1">
                                        to
                                    </div>
                                    <div class="col-md-2">
                                        {{ line.to }}
                                    </div>
                                    <div class="col-md-1">
                                        ${{ line.admissionFee }}
                                    </div>
                                    <div class="col-md-2 over_ride_price_mooring_body d-none">
                                        <div class="input-group input-group-sm">
                                            <span class='input-group-text'>$</span>
                                            <input type='number' :id='line.rowid' step='0.01' class='form-control' @blur="admission_money_update($event,index)" v-model.number="line.override_price">
                                        </div>
                                    </div>
                                </div>
                                {% endverbatim %}
                            </div>
                            <h3 class="text-primary mt-4">Adjustments</h3>
                            {% for bc in booking_change_fees %}
                                <div class="row align-items-center py-2">
                                    <div class="col-md-9">
                                        {{ bc.description }}
                                    </div>
                                    <div class="col-md-2 text-end">
                                        ${{ bc.amount }}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <div class="hiddenBookings d-none">
                            <input type="hidden" id="bookingLines" v-model="bookingLines" name="bookingLines"/>
                        </div>
                        <div class="hiddenAdmissions d-none">
                            <input type="hidden" id="admissionsLines" v-model="admissionsLines" name="admissionsLines"/>
                        </div>
                        <div class="hiddenocc d-none">
                            <input type="hidden" id="occ" v-model="occ" name="occ"/>
                        </div>
                        <div class="col-md-2" style='display:none'>
                              <img alt="campground"  class="img-thumbnail img-responsive" src="{{ booking.campground.first_image.image.url }}" style='display:none'>
                              <p class="pricing" v-cloak >
                            {% verbatim %}
                                  <strong>${{ perDayFee|formatMoney(2) }}</strong>
                            {% endverbatim %}
                                  <br> <span class="text-muted">Per day</span>
                              </p>
                        </div>
                        <div class="col-md-10" style='display:none'>
                            <div class="row form-horizontal">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label class="col-sm-4 control-label pull-left required">Marine Park: </label>
                                        <div class="col-sm-8">
                                            {{ booking.mooringarea.name }} , {{ booking.mooringarea.park.name }}
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="col-sm-4 control-label pull-left required">Mooring : </label>
                                        <div class="col-sm-8">
                                        {% if booking.mooringarea.site_type == 2 %}
                                            {{ booking.first_campsite.type }}
                                        {% else %}
                                            {{ booking.first_campsite.name }} ({{ booking.first_campsite.type }})
                                        {% endif %}
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label class="col-sm-4 control-label pull-left required" >Dates: </label>
                                        <div class="col-sm-8">
                                            <div class="input-group date">
                                                {{ booking.stay_dates }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="form-group" style='display:none'>
                                        <label class="col-sm-4 control-label pull-left required">{{ form.num_adult.label_tag }} </label>
                                        <div class="col-sm-8">
                                                {{ form.num_adult }}
                                        </div>
                                    </div>
                                    <div class="form-group" style='display:none'>
                                        <label class="col-sm-4 control-label pull-left required">{{ form.num_concession.label_tag }} </label>
                                        <div class="col-sm-8">
                                                {{ form.num_concession }}
                                        </div>
                                    </div>
                                    <div class="form-group" style='display:none' >
                                        <label class="col-sm-4 control-label pull-left required">{{ form.num_child.label_tag }} </label>
                                        <div class="col-sm-8">
                                                {{ form.num_child }}
                                        </div>
                                    </div>
                                    <div class="form-group" style='display:none'>
                                        <label class="col-sm-4 control-label pull-left required">{{ form.num_infant.label_tag }} </label>
                                        <div class="col-sm-8">
                                                {{ form.num_infant }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12" v-cloak v-if="concessionWarning">
                            Please note, only holders of the following Australian-issued cards are entitled to concessions:
                            <ul>
                                <li>Seniors Card</li>
                                <li>Age Pension</li>
                                <li>Disability Support</li>
                                <li>Carer Payment</li>
                                <li>Carer Allowance</li>
                                <li>Companion Card</li>
                                <li>Department of Veterans' Affairs</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <!-- Left Column: Personal Details -->
            <div class='col-lg-6'>
                <div class="p-3 bg-light border rounded h-100">
                    <div class="row">
                        <div class="col-lg-12">
                            <h3 class="text-primary">Personal Details</h3>
                        </div>
                    </div>
                    <div class="row mb-3">
                    {% if request.user.is_anonymous or request.user.is_staff %}
                        <div class="col-md-6">
                            {{ form.email.label_tag }}
                            {{ form.email|class:'form-control' }}
                        </div>
                        <div class="col-md-6" >
                            {{ form.confirm_email.label_tag }}
                            {{ form.confirm_email|class:'form-control' }}
                        </div>
                    {% else %}
                        <div class="col-md-12">
                            <p>Logged in as user <b>{{ request.user.email }}</b>.</p>
                        </div>
                    {% endif %}
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            {{ form.first_name.label_tag }}
                            {{ form.first_name|class:'form-control' }}
                        </div>
                        <div class="col-md-6">
                            {{ form.last_name.label_tag }}
                            {{ form.last_name|class:'form-control' }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            {{ form.postcode.label_tag }}
                            {{ form.postcode|class:'form-control' }}
                        </div>
                        <div class="col-md-6">
                            {{ form.country.label_tag }}
                            {{ form.country|class:'form-control' }}
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            {{ form.phone.label_tag }}
                            {{ form.phone|class:'form-control' }}
                        </div>
                    </div>
                </div>
            </div>
            <!-- Right Column: Vessels -->
            <div class='col-lg-6'>
                <div class="p-3 bg-light border rounded h-100">
                    <div class="row">
                        <div class="col-lg-12">
                            <h3 class="text-primary">Vessels</h3>
                            <p v-if="pricing.vehicle"><b><a href="{{EXPLORE_PARKS_ENTRY_FEES}}" target="_blank">Entry fees</a> are required for each vehicle entering this park.</b></p>
                            <p class='d-none' v-else>No entry fees are required for this park.</p>
                        </div>
                    </div>
                    {# Manual rendering of the 'vehicles' formset. #}
                    {# Django 1.11 will move form rendering junk into proper templates, #}
                    {# so there should be a cleaner way of doing this in future. #}
                    <div class="row d-none" v-cloak>
                        <div class="col-md-4">
                            <div class="form-group">
                                <label class='d-none'>Number of vessels:
                                    <input class="form-control" name="form-TOTAL_FORMS" max="8" min="1" value="1" v-model="vehicleCount" @change="updateVehicles" type="number"/>
                                    <input id="id_form-INITIAL_FORMS" name="form-INITIAL_FORMS" type="hidden" value="1" />
                                    <input id="id_form-MIN_NUM_FORMS" name="form-MIN_NUM_FORMS" type="hidden" value="0" />
                                    <input id="id_form-MAX_NUM_FORMS" name="form-MAX_NUM_FORMS" type="hidden" value="8" />
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="text-end">Vessel Registration:</label>
                            <input class="form-control" type="text" v-model="rego" required @change="searchRego()" style="text-transform:uppercase" readonly/>

                            <div v-for="(vehicle, index) in vehicles" class="d-none">
                                <select @change="calculateTotal" v-bind:name="'form-'+Number(index).toString()+'-vehicle_type'" class="form-control" v-model="vehicle[0]" >
                                    <option value="0">Vessel</option>
                                </select>
                                <label for="'form-'+Number(index).toString()+'-vehicle_rego'" class="text-right" >Vessel</label><label>&nbspRegistration:</label>
                                <input class="form-control" v-bind:name="'form-'+Number(index).toString()+'-vehicle_rego'" type="text" v-model="vehicle[1]" @change="searchRego()" style="text-transform:uppercase;" readonly/>
                            </div>
                        </div>
                    </div>
                        <!-- <div class="col-md-4">
                            <div class="checkbox" v-if="pricing.vehicle"><label><input v-bind:name="'form-'+Number(index).toString()+'-entry_fee'" type="checkbox" v-model="vehicle[2]" @change="updateVehicles"/> Entry fee</label></div>
                        </div> -->
                    
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="vessel_size" class="text-right">Vessel Size (Meters)</label>
                                    <input type="number" class="form-control" id="vessel_size" name="size" v-model="size" readonly/>
                                </div>
                                <div class="col-md-6">
                                    <label for="vessel_draft" class="text-right">Vessel Draft (Meters)</label>
                                    <input type="number" class="form-control" id="vessel_draft" name="draft" v-model="draft" readonly/>
                                </div>
                                <div class="col-md-6">
                                    <label for="vessel_beam" class="text-right">Vessel Beams (Meters)</label>
                                    <input type="number" class="form-control" id="vessel_beam" name="size" v-model="beam" readonly/>
                                </div>
                                <div class="col-md-6">
                                    <label for="vessel_weight" class="text-right">Vessel Weight (Tonnes)</label>
                                    <input type="number" class="form-control" id="vessel_weight" name="draft" v-model="weight" readonly/>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div v-if="linesAdmissions.length > 0">
                        <h3 class="text-primary">Guest Details</h3>
                        <div v-if="payingAdmissions" class="row g-3">
                            <div class="col-md-4">
                                <label for="num_adults" class="text-end">Adults (ages 12+):</label>
                                <input type="number" class="form-control" id="numAdults" name="num_adults" v-model="numAdults" @change="guestsUpdated()" min="0" max="16"/>
                            </div>
                            <div class="col-md-4">
                                <label for="num_children" class="text-end">Children (ages 4-12):</label>
                                <input type="number" class="form-control" id="numChildren" name="num_children" v-model="numChildren" @change="guestsUpdated()" min="0" max="16"/>
                            </div>
                            <div class="col-md-4">
                                <label for="num_infants" class="text-end">Infants (ages 0-4):</label>
                                <input type="number" class="form-control" id="numInfants" name="num_infants" v-model="numInfants" @change="guestsUpdated()" min="0" max="16"/>
                            </div>
                            <div class="col-md-4">
                            </div>

                            <div class="row d-none">
                                <div class="small-6 columns">
                                    <label for="num_concessions" class="text-end"><span class="has-tip" title="Holders of one of the following Australian-issued cards:
                                        - Seniors Card
                                        - Age Pension
                                        - Disability Support
                                        - Carer Payment
                                        - Carer Allowance
                                        - Companion Card
                                        - Department of Veterans' Affairs">Concessions</span>
                                    </label>
                                </div><div class="small-6 columns">
                                    <input type="number" id="numConcessions" name="num_concessions" v-model="numConcessions" min="0" max="16"/></label>
                                </div>
                            </div>
                            <div class="row d-none">
                                <div class="small-6 columns">
                                    <label for="num_children" class="text-right">Moorings<label>
                                </div>
                                <div class="small-6 columns">
                                    <input type="number" id="numMooring" name="num_mooring" v-model="numMooring" min="0" max="16"/></label>
                                </div>
                            </div>

                        </div>
                        <div v-else>
                            <div class="row">
                                <div class="col-md-12">
                                    No admission fees required for {% verbatim %} {{ rego.toUpperCase() }} {% endverbatim %}
                                </div>
                            </div>
                        </div>
                     </div>
                </div>
                <template v-if="pricing.vehicle">
                    <div class="row" v-cloak>
                        <div class="col-md-12">
                    {% verbatim %}
                            <p>Entry fee total: <strong>${{ entryFee|formatMoney(2) }}</strong></p>
                    {% endverbatim %}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <b>NOTE:</b> A vehicle entry fee is not required for the holder of a valid <a href="https://shop.dpaw.wa.gov.au/park-passes">Park Pass</a>.
                        </div>
                    </div>
                </template>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-lg-12">
                <div class="p-3 bg-light border rounded">
                    <!-- Sub-row for Total Price and main action buttons -->
                    <div class="row align-items-center">
                        <!-- Left Column: Total Price -->
                        <div class="col-md-6">
                            <label for="totalPrice" class="h5">Total Price <span class="text-muted small">(GST inclusive.)</span></label>
                            <div class="input-group input-group-lg">
                                <span class="input-group-text">AUD $</span>
                                <input id="totalPrice" type="text" class="form-control" :value="total|formatMoney(2)" readonly="true">
                            </div>
                        </div>

                        <!-- Right Column: Checkbox and Submit Button -->
                        <div class="col-md-6">
                            <div class="d-flex justify-content-end align-items-center">
                                <div class="form-check me-3">
                                    <input type="checkbox" id="toc_check" class="form-check-input" v-model="toc">
                                    <label for="toc_check" class="form-check-label">I agree to the <a target="_blank" href="{{EXPLORE_PARKS_TERMS}}">terms and conditions</a></label>
                                </div>
                                <button v-if="total >= 0" :disabled="!toc" type="submit" class="btn btn-primary btn-lg">Proceed to payment</button>
                                <button v-else :disabled="!toc" type="submit" class="btn btn-primary btn-lg">Proceed to Refund</button>
                            </div>
                        </div>
                    </div>

                    {% if request.user.is_staff %}
                    <div class="row border-top mt-3 pt-3">
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input type="checkbox" id="nononline" name="nononline" class="form-check-input" v-model="nononline" @change="calculateTotal()" checked>
                                <label for="nononline" class="form-check-label">Phone Booking Fee</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" id="override" name="override" class="form-check-input" v-model="override">
                                <label for="override" class="form-check-label">Override Price</label>
                            </div>
                        </div>
                        <div class="col-md-6" v-if="override">
                            <label for="overrideReason">Reason:</label>
                            <select class="form-select" name="overrideReason" id="overrideReason" v-model="selectedReason">
                                <option value=''>None</option>
                                <option v-for="res in override_reasons" :value="res.id">{% verbatim %}{{res.text}}{% endverbatim %}</option>
                            </select>
                            <label for="overrideDetail" class="mt-2">Details:</label>
                            <textarea v-model="overrideDetail" name="overrideDetail" id='overrideDetail' class='form-control' style="resize:none;"></textarea>
                            <p class="text-danger small mt-1">
                                Note, these details will show on the customer invoice.
                            </p>
                        </div>
                    </div>
                    {% endif %}
                    <!-- <p class="text-muted" >
                        Payments will be recorded against the booking once the booking is completed and the payment is received.
                    </p> -->
                </div>
            </div>
        </div>
    </div>
    </form>
{% endif %}
</div>
{% endblock %}

{% block custom_js %}
{{ block.super }}
{% if booking %}
<script src="/static/common/js/moment.min.js?ver={{ GIT_COMMIT_HASH }}"></script>
<script src="/static/common/js/vue.min.js?ver={{ GIT_COMMIT_HASH }}"></script>
<link href="/static/common/css/select2.min2.css?ver={{ GIT_COMMIT_HASH }}" rel="stylesheet"/>
<script src="/static/common/js/select2.min.js?ver={{ GIT_COMMIT_HASH }}"></script>
<script src="/static/common/js/sweetalert2.js"></script>
<link rel="stylesheet" href="/static/common/css/sweetalert2.css"/>
<script type="text/javascript">
    var book = new Vue({
        el: '#addBooking',
        data: function() {
            return {
            expiry: moment('{{ expiry|escapejs }}'),
            timer: {{ timer }},
            pricing: {
                vehicle: {{ pricing.vehicle }},
                vehicleConc: {{ pricing.vehicle_conc }},
                motorcycle: {{ pricing.motorcycle }}
            },
            vehicles: [
                [0, '', true]
            ],
            perDayFee: 0,
            entryFee: 0,
            total: 0,
            concessionWarning: false,
            numAdults: {% if details.num_adult > 0 %}{{ details.num_adult }}{% else %}0{% endif %},
            numChildren: {% if details.num_children > 0 %}{{ details.num_children }}{% else %}0{% endif %},
            numInfants: {% if details.num_infant > 0 %}{{ details.num_infant }}{% else %}0{% endif %},
            linesAdmissions: {{ lines|safe }},
            linesBooking: {},
            bookingLines: "",
            admissionsLines: [],
            numConcessions: 0,
            numMooring: 0,
            vehicleCount: 1,
            payingAdmissions: true,
            size: {{ details.vessel_size }},
            draft: {{ details.vessel_draft }},
            beam: {{ details.vessel_beam }},
            weight: {{ details.vessel_weight }},
            rego: '{{ details.vessel_rego }}',
            admissionFee: 0,
            nononline: false,
            override: false,
            overridePrice: 0,
            overrideReason: '',
            override_reasons: [],
            overrideDetail: '',
            isStaff: {{ staff }},
            nonOnlineFee: 0,
            isFirst: true,
            toc: false,
            booking_id: {{ booking.id }},
            booking_change_fees: {{ booking_change_fees|safe }},
            occ: '{{ occ }}'
    
            }
        },
        filters:{
            formatMoney:function(n,c, d, t){
                c = isNaN(c = Math.abs(c)) ? 2 : c;
                d = d == undefined ? "." : d;
                t = t == undefined ? "," : t;
                var s = n < 0 ? "-" : "";
                var i = String(parseInt(n = Math.abs(Number(n) || 0).toFixed(c)));
                var j = (j = i.length) > 3 ? j % 3 : 0;
               return s + (j ? i.substr(0, j) + t : "") + i.substr(j).replace(/(\d{3})(?=\d)/g, "$1" + t) + (c ? d + Math.abs(n - i).toFixed(c).slice(2) : "");
             }
        },
        watch: {
            override: function (val){
                console.log("Something changed");
                if (val) {
                     $('.over_ride_price_mooring_header').show();
                     $('.over_ride_price_mooring_body').show();
     
//                    this.$nextTick(() => {
                       this.$nextTick(function() {
                        $('.overrideReason').select2({
                            minimumResultsForSearch: Infinity
                        }).
                        on("select2:select",function (e) {
                            var selected = $(e.currentTarget);
                            this.overrideReason = selected.val();
                        }).
                        on("select2:unselect",function (e) {
                            var selected = $(e.currentTarget);
                            this.overrideReason = selected.val();
                        }); 
                    })
                } else {
                     $('.over_ride_price_mooring_header').hide();
                     $('.over_ride_price_mooring_body').hide();
		}
                
            }
        },
        computed: {
            numPeople: {
                get: function get(){
                    var count = parseInt(this.numAdults) + parseInt(this.numChildren) + parseInt(this.numInfants);
                    if (count === 1) {
                        return count +" person ▼";
                    } else {
                        return count + " people ▼";
                    }
                }
            },
            timeleft: {
                cache: false,
                get: function get() {
                    // Minutes and seconds
                    var mins = ~~(this.timer / 60);
                    var secs = this.timer % 60;

                    // Hours, minutes and seconds
                    var hrs = ~~(this.timer / 3600);
                    var mins = ~~((this.timer % 3600) / 60);
                    var secs = this.timer % 60;

                    // Output like "1:01" or "4:03:59" or "123:03:59"
                    var ret = "";

                    if (hrs > 0) {
                        ret += "" + hrs + ":" + (mins < 10 ? "0" : "");
                    }

                    ret += "" + mins + ":" + (secs < 10 ? "0" : "");
                    ret += "" + secs;
                    return ret;
                }
            }
        },
        methods:{
            createCookie: function(name, value, days) {
                var expires;
            
                if (days) {
                    var date = new Date();
                    date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
                    expires = "; expires=" + date.toGMTString();
                } else {
                    expires = "";
                }
                document.cookie = encodeURIComponent(name) + "=" + encodeURIComponent(value) + expires + "; path=/";
            },
            updateLocalStorage: function() {
                var vm = this;
                var data = {
                    booking: vm.booking_id,
                    vehicles: vm.vehicles
                } 
                localStorage.setItem('checkoutVehicleData',JSON.stringify(data));
            },
            updateVehicles: function () {
                var vm = this;
                var diff = vm.vehicles.length - vm.vehicleCount
                if (diff < 0) {
                    for (var i=0; i<-diff; i++) {
                        vm.vehicles.push([0, vm.rego, true]);
                    }
                } else if (diff > 0) {
                    for (var i=0; i<diff; i++) {
                        vm.vehicles.pop();
                    }
                }
                vm.calculateTotal();

                vm.updateLocalStorage();
            },
            searchRego: function(rego){
                console.log('in searchRego()')
                let vm = this;
                if (rego){
                    var reg = rego;
                } else {
                    var reg = vm.rego
                }
                var data = {
                    'rego': reg
                }
                if(reg){
                    $.ajax({
                        url: "/api/registeredVessels/",
                        dataType: 'json',
                        data: data,
                        method: 'GET',
                        success: function(data, stat, xhr) {
                            if(data[0]){
                                if (vm.linesAdmissions.length > 0){
                                    if (data[0].admissionsPaid){
                                        vm.payingAdmissions = false;
                                    } else {
                                        vm.payingAdmissions = true;
                                    }
                                    vm.calculateTotal();
                                }                                
                            } else {
                                console.log("Registration was not found.");
                                if (vm.linesAdmissions.length > 0){
                                    vm.payingAdmissions = true;
                                }
                                vm.calculateTotal();
                            }
                        }
                    });
                    vm.isFirst = false;
                }
            },
            getCookie: function(name){
                var cookieValue = null;
                if (document.cookie && document.cookie != ''){
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++){
                        var cookie = $.trim(cookies[i]);
                        if(cookie.substring(0, name.length +1) === (name + '=')){
                            cookieValue = decodeURIComponent(cookie.substring(name.length +1));
                            break;
                        }
                    }
                }
                return cookieValue;
            },
            csrfSafeMethod: function(method){
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            },
            guestsUpdated: function() {
                let vm = this;
                console.log(vm.numAdults);

                if (vm.numAdults < 0) { 
                    var error = {
                        title : "Invalid Guest Amount",
                        text : "Number of guests cannot be a negative or zero value.",
                        type : "error",
                    }
                    vm.swalMessage(error); 
	                vm.numAdults = 1;
	                return false;
                }



                var details = {
                    'num_adults' : parseInt(vm.numAdults),
                    'num_children' : parseInt(vm.numChildren),
                    'num_infants' : parseInt(vm.numInfants),
                    'vessel_rego' : vm.rego,
                    'vessel_size' : vm.size,
                    'vessel_draft' : vm.draft,
                    'vessel_beam' : vm.beam,
                    'vessel_weight' : vm.weight
                }
                data = {
                    booking : vm.booking_id,
                    details : JSON.stringify(details)
                }
                csrftoken = vm.getCookie('csrftoken');
                $.ajax({
                    beforeSend: function(xhr, settings){
                        if (!vm.csrfSafeMethod(settings.type) && !this.crossDomain){
                            xhr.setRequestHeader('X-CSRFToken', csrftoken);
                        }
                    },
                    url: "/api/booking/" + vm.booking_id + "/",
                    contentType: 'application/json',
                    dataType: 'json',
                    data: JSON.stringify(data),
                    async: true,
                    method: "PATCH",
                    success: function(data, stat, xhr){
                        console.log("Updated guests");
                    }
                });
                vm.calculateTotal();
            },
            format_money: function(total, comma) {
               if (comma == null) {
                        comma = true;
               }
               if (total == null) {
                  total = '0.00';
               }
               var neg = false;
               if(total < 0) {
                   neg = true;
                   total = Math.abs(total);
               }
               if (comma == true) {
                   return (neg ? "-" : '') + parseFloat(total, 10).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, "$1,").toString();
               } else {
                   return (neg ? "-" : '') + parseFloat(total, 10).toFixed(2).replace(/(\d)(?=(\d{3})+\.)/g, "$1").toString();
               }
            },
            admission_money_update: function(e,index) {
                  var vm = this;
                  

                  this.linesAdmissions[index-1].override_price = this.format_money(event.target.value, false);
	          vm.calculateTotal();
	
	    },
            money_update: function() {
                var vm = this;
                event.target.value = this.format_money(event.target.value, false);
                $("#mooring_pricing_table").find('input').each(function() {
                          field = $('#'+this.id);
                          if (this.type == 'number') {
                               console.log(this.id);
                               console.log(this.value.length);
                               var booking_row_id = this.id.replace("over_ride_mooring_price","");
                               vm.linesBooking[booking_row_id] = $('#'+this.id).val();
                          }
                });
                vm.calculateTotal(); 
                console.log("MONEY UPDATE")
                console.log(vm.bookingLines) 
            },
            calculateTotal: function () {
                var vm = this;
                var form = document.forms.addBookingForm;
                var override_checked = $('#override').prop("checked");
                vm.entryFee = 0;
                vm.total = 0;
                vm.total = '{{ booking_total }}';
                vm.total = parseFloat(vm.total);
                vm.admissionFee = 0;
                console.log("BOOKING CHANGE FES");
                console.log(vm.booking_change_fees)
                console.log(override_checked);
                console.log("BOOKING TOTAL");
                console.log("{{ booking_total }}");
                // admissions_pricing_table
                if (override_checked == true ) {
                    vm.total = parseFloat('0.00');
                    for (var i = 0; i < vm.booking_change_fees.length; i++) {
                           console.log(vm.booking_change_fees[i].amount);
                           vm.total = vm.total + parseFloat(vm.booking_change_fees[i].amount);

                    }

                    $("#mooring_pricing_table").find('input').each(function() {
                             console.log(this.value);
                             console.log(this.id);
                             if (this.type == 'number') {
                                  if (this.value > 0 ) {
                                  } else {
                                      this.value = '0.00';
                                  }
                                  vm.total = vm.total + parseFloat(this.value);
                                  console.log(this.value);
                             }
                    });
                }
                if (vm.nononline){
                    vm.total += (vm.nonOnlineFee/100);
                }

                

                if (vm.payingAdmissions){
                    // Will need to calculate price per person based on input.

                    var family = 0;
                    var adults = vm.numAdults;
                    var children = vm.numChildren;

                    if (adults > 1 & children > 1){
                        if (adults == children){
                            if (adults % 2 == 0){
                                family = adults/2;
                                adults = 0;
                                children = 0;
                            } else {
                                adults -= 1;
                                family = adults/2;
                                adults = 1;
                                children = 1;
                            }
                        }
                        else if (adults > children){
                            if (children % 2 == 0){
                                family = children/2;
                                adults -= children;
                                children = 0;
                            } else {
                                children -= 1;
                                family = children/2;
                                adults -= children;
                                children = 1;
                            }
                        } else {
                            if (adults % 2 == 0){
                                family = adults/2;
                                children -= adults;
                                adults = 0;
                            } else {
                                adults -= 1;
                                family = adults/2;
                                children -= adults;
                                adults = 1;
                            }
                        }
                    }
 
                    // Then calculate per line, adding as we go.
                    for (var i = 0; i < vm.linesAdmissions.length; i++){
                        var thisAdmission = 0;
                        if (vm.linesAdmissions[i].from != vm.linesAdmissions[i].to) {
                            thisAdmission += (vm.numInfants * parseFloat(vm.linesAdmissions[i].infant_on));
                            thisAdmission += (adults * parseFloat(vm.linesAdmissions[i].adult_on));
                            thisAdmission += (children * parseFloat(vm.linesAdmissions[i].child_on));
                            thisAdmission += (family * parseFloat(vm.linesAdmissions[i].family_on));
                        } else {
                            thisAdmission += (vm.numInfants * parseFloat(vm.linesAdmissions[i].infant));
                            thisAdmission += (adults * parseFloat(vm.linesAdmissions[i].adult));
                            thisAdmission += (children * parseFloat(vm.linesAdmissions[i].child));
                            thisAdmission += (family * parseFloat(vm.linesAdmissions[i].family));
                        }
                        vm.linesAdmissions[i].admissionFee = parseFloat(thisAdmission).toFixed(2);
                        vm.admissionFee += parseFloat(thisAdmission);
                        if (override_checked == true) {
                            console.log("ADMISSIONS OVERRIDE");
                            console.log(vm.linesAdmissions[i].override_price);
                            var override_price = vm.linesAdmissions[i].override_price;

                            if (vm.linesAdmissions[i].override_price == undefined) {
                                 override_price = parseFloat('0.00');
                            }

                            if (override_price > 0) {
			    } else {
				override_price = parseFloat('0.00');
			    }

                            vm.total += parseFloat(override_price);
                        } else {
                            vm.total += parseFloat(thisAdmission);
                        }

                    }

                }
                vm.admissionsLines = JSON.stringify(vm.linesAdmissions);
                vm.bookingLines = JSON.stringify(vm.linesBooking);
                return;
            },
            validate: function (e) {
                var vm = this;
                var isValid = true;
                var form = document.forms.addBookingForm;
                var override_checked = $('#override').prop("checked");

                var fields = $(form).find(':input');
                $('.tooltip-err').tooltip("dispose");
                $.each(fields, function(i, field) {
                    $(field).removeClass('tooltip-err');
                    $(field).closest('.form-group').removeClass('has-error');
                    if ($(field).attr('required') == 'required' || $(field).attr('required') == 'true') {
                        var inputStr = $(field).val();
                        if (inputStr == "" || inputStr == null) {
                             var errMsg = $(field).attr('data-error-msg') ? $(field).attr('data-error-msg') : "Field is required";
                             $(field).closest('.form-group').addClass('has-error');
                               $(field).focus();
                               $(field).select();
                               $(field).addClass('tooltip-err');
                               $(field).tooltip()
                                   .attr("data-original-title", errMsg)
                             isValid = false;
                         }
                    }
                });


                if (override_checked == true ) {
                    console.log('over ride');
                    var overrideReason = $('#overrideReason').val(); 
                    $("#mooring_pricing_table").find('input').each(function() {
                             field = $('#'+this.id);
                             if (this.type == 'number') {
                                  if (this.value.length > 3 && parseFloat(this.value) >= 0 ) {
                                  } else {
                                      isValid = false;
                                      $(field).closest('.form-group').addClass('has-error');
                                      $(field).focus();
                                      $(field).select();
                                      $(field).addClass('tooltip-err');
                                      $(field).tooltip().attr("data-original-title", "Please complete all mooring override pricing amounts either with same price or price equal to or greater than zero.")

                                  }
                                  console.log(this.value);
                             }
                    });

                    $("#admissions_pricing_table").find('input').each(function() {
                             console.log(this.id);
                             field = $('#'+this.id);
                             if (this.type == 'number') {
                                  if (this.value.length > 3 && parseFloat(this.value) >= 0 ) {
                                  } else {
                                      isValid = false;
                                      $(field).closest('.form-group').addClass('has-error');
                                      $(field).focus();
                                      $(field).select();
                                      $(field).addClass('tooltip-err');
                                      $(field).tooltip().attr("data-original-title", "Please complete all admissions override pricing amounts either with same price or price equal to or greater than zero.")

                                  }
                                  console.log(this.value);
                             }
                    });
                    if (overrideReason > 0 ) { 
		    } else  {
                         var field = $('#overrideReason');
                         isValid = false;
                         $(field).closest('.form-group').addClass('has-error');
                         $(field).focus();
                         $(field).select();
                         $(field).addClass('tooltip-err');
                         $(field).tooltip().attr("data-original-title", "Please select and override reason.")

 	            }
                    if (vm.overrideDetail.length > 5) {
		    } else {
                         var field = $('#overrideDetail');
                         isValid = false;
                         $(field).closest('.form-group').addClass('has-error');
                         $(field).focus();
                         $(field).select();
                         $(field).addClass('tooltip-err');
                         $(field).tooltip().attr("data-original-title", "Please enter a valid over ride details length.")
		    }

                   

                }
                vm.bookingLines = JSON.stringify(vm.linesBooking);
                console.log(vm.linesBooking);
                if (isValid) {
                    form.submit();
                }
            },
            swalMessage: function(value){
                Swal({
                title: value.title,
                text: value.text,
                type: value.type,
                width: '30%',
                showCancelButton: false,
                confirmButtonText: 'OK',
                showLoaderOnConfirm: true,
                allowOutsideClick: false
                });
            },
        },
        mounted: function() {
            console.log('in mounted...')
            var vm = this;

            vm.createCookie('checkouthash', "{{ checkouthash }}");

            // check that expiry is in a sane range
            var saneTz = (0 < Math.floor((vm.expiry - moment.now())/1000) < vm.timer);

            // update the countdown timer every second
            var timer = setInterval(function (ev) {
                // fall back to the pre-encoded timer
                if (!saneTz) {
                    vm.timer -= 1;
                } else {
                    // if the timezone is sane, do live updates 
                    // this way unloaded tabs won't cache the wrong time.
                    var newTimer = Math.floor((vm.expiry - moment.now())/1000);
                    vm.timer = newTimer;
                }

                if ((vm.timer <= 0)) {
                    clearInterval(timer);
                    var loc = window.location;
                    window.location = loc.protocol + '//' + loc.host + loc.pathname;
                } 
            }, 1000);

            if (vm.linesAdmissions.length > 0){
                vm.payingAdmissions = true;
            } else {
                vm.payingAdmissions = false;
            }

            // wire up events to the form controls
            // TODO: for django 1.11 replace python form controls with templates;
            // should be easier to inject vue stuff
            var cbCalc = function (ev) {
                vm.calculateTotal();
            };

            document.forms.addBookingForm.num_adult.addEventListener('change', cbCalc);
            document.forms.addBookingForm.num_concession.addEventListener('change', cbCalc);
            document.forms.addBookingForm.num_child.addEventListener('change', cbCalc);
            document.forms.addBookingForm.num_infant.addEventListener('change', cbCalc);

            // update the vehicle data from local storage
            var storedData = localStorage.getItem('checkoutVehicleData');
            if (storedData){
                try{
                    storedData = JSON.parse(storedData);
                    if (storedData.hasOwnProperty('booking') && storedData.hasOwnProperty('vehicles') && parseInt(storedData.booking) == parseInt(vm.booking_id)){ 
                        if (Array.isArray(storedData.vehicles)){
                            var length = storedData.vehicles.length;
                            vm.vehicles = [];
                            $.each(storedData.vehicles, function(i,v) {
                                vm.vehicles.push([i, vm.rego, true]);
                            });
                            vm.vehicleCount = length;
                        }
                    }
                    else{
                        localStorage.removeItem('checkoutVehicleData');
                    }
                }
                catch(e){
                }
            }
            //Set the rego if entered.
            vm.isFirst = true;
            if (vm.rego !== ""){
                console.log(vm.rego);
                vm.vehicles = [[0, vm.rego, true]];
                console.log(vm.vehicles)
                // vm.searchRego(vm.rego);
            }
            
            $.get("/api/discountReasons/",function (data) {
                vm.override_reasons = data;
            });

            if (vm.isStaff){
                data = {
                    'key': '0'
                }
                $.ajax({
                    url: "/api/global_settings",
                    dataType: 'json',
                    data: data,
                    async: true,
                    method: "GET",
                    success: function(data, stat, xhr){
                        if (data == "Error more than 1 group"){
                            console.log("group error");
                            var error = {
                                title : "Invalid Group",
                                text : "Please alert admin, you are part of no or too many mooring groups. Unable to perform bookings.",
                                type : "error",
                            }
                            vm.swalMessage(error);
                            $('#toc_check').prop('disabled', "disabled");
                            vm.toc = false;
                        } else {
                            console.log(data[0].value);
                            var intval = parseInt(data[0].value);
                            intval *= 100;
                            vm.nonOnlineFee = intval;
                            if (intval > 0){
                                vm.nononline = true;
                            }
                            vm.calculateTotal();
                        }
                    }
                });
            }
            vm.calculateTotal();
            // console.log("FEE CHANGE");
	    // console.log(vm.booking_change_fees);
            $('#override').on("click", function() {
                    var override_checked = $('#'+this.id).prop("checked"); 
                    for (var i = 0; i < vm.linesAdmissions.length; i++){
                        var thisAdmission = 0;
                        if (override_checked == true) {
                            console.log("ADMISSIONS OVERRIDE");
                            console.log(vm.linesAdmissions[i].override_price);
                            var override_price = vm.linesAdmissions[i].override_price;

                            if (vm.linesAdmissions[i].override_price == undefined) {
                                 vm.linesAdmissions[i].override_price = vm.linesAdmissions[i].admissionFee;
                            }

                            if (override_price > 0) {
                            } else {
                                 vm.linesAdmissions[i].override_price = vm.linesAdmissions[i].admissionFee; 
                            }

                        }

                    }

               vm.calculateTotal(); 
            });

            $( "#id_email" ).change(function() {
                var email = this.value;
                $.ajax({
                    url: "/api/profile-admin?email_address="+email,
                    dataType: 'json',
                    data: data,
                    async: true,
                    method: "GET",
                    success: function(data, stat, xhr){
                        $('#id_confirm_email').val(data['email']);
                        $('#id_first_name').val(data['first_name']);
                        $('#id_last_name').val(data['last_name']);
                        if (data['mobile_number'] > 5) {
				$('#id_phone').val(data['mobile_number']);
			} else {
 				$('#id_phone').val(data['phone_number']);
			}
                        if (data['residential_address'] != null) {
				$('#id_postcode').val(data['residential_address']['postcode']);
                                $('#id_country').val(data['residential_address']['country']);
                                
			}
                        console.log(data);
                    }
                });
            });
        }
    });
</script>
<style>
.swal2-popup {
    font-size: 20px !important;
}
</style>
{% endif %}
{% endblock %}
